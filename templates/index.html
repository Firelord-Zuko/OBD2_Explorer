<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OBD-II Explorer v1.3.9</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Custom stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
</head>

<body class="light-mode">

  <div class="container my-4">
    <div class="content">
      <h1 class="text-center mb-3">üöó OBD-II Explorer v1.3.9</h1>
      <p class="text-center instruction-text">
        Enter an OBD-II code (P0000 to P0812) to view details, DIY fixes, and helpful resources.<br>
        Codes missing a ‚ÄúP‚Äù or leading zeros will be automatically corrected.
      </p>

      <!-- ‚úÖ Centered input -->
      <div class="d-flex justify-content-center mb-3">
        <div class="input-wrapper">
          <input type="text" id="codeInput" inputmode="text" pattern="[A-Za-z0-9]*"
                 class="form-control text-center" placeholder="Enter code (P0001‚ÄìP0812)" autofocus />
        </div>
      </div>

      <!-- ‚úÖ Toolbar -->
      <div class="mobile-toolbar">
        <button id="toolbarLookup">üîç Lookup</button>
        <button id="toolbarClear">üóëÔ∏è Clear</button>
        <button id="toolbarDark">üåô Dark</button>
      </div>

      <div class="text-center">
        <div class="spinner-border text-primary" id="loadingSpinner" role="status" style="display:none;">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>

      <div id="result" style="display: none;">
        <h5 id="codeTitle" class="mt-3"></h5>

        <h6 class="mt-3 section-icon">üìú Summary:</h6>
        <p id="summary" class="summary-text"></p>

        <h6 class="mt-3 section-icon">üìò Description:</h6>
        <p id="description"></p>

        <h6 class="mt-3 section-icon">üß∞ DIY Recommendations:</h6>
        <div id="recommendation"></div>
        <p class="collapse-section" id="toggleTips" style="display: none;">View More Tips ‚ñº</p>

        <h6 class="mt-3 section-icon">üîó Forums & Resources:</h6>
        <div class="forum-links" id="forums"></div>

        <div id="recentHistorySection" class="mt-4">
          <h6 class="collapse-section section-icon" id="toggleHistory">üïò Recent Lookups ‚ñº</h6>
          <div id="historyContainer" style="display: none;"></div>
        </div>

        <p class="small mt-3" id="metaInfo"></p>
      </div>
    </div>
  </div>

  <footer class="text-center mt-4 mb-2 small text-muted">
    <p>v1.3.9 | Sanford Janes Witcher III | Offline AI Diagnostics</p>
  </footer>

  <script>
    const body = document.body;
    const spinner = document.getElementById("loadingSpinner");
    const historyContainer = document.getElementById("historyContainer");
    const toggleHistory = document.getElementById("toggleHistory");
    const toolbarDark = document.getElementById("toolbarDark");
    const toolbarClear = document.getElementById("toolbarClear");
    const toolbarLookup = document.getElementById("toolbarLookup");
    const codeInput = document.getElementById("codeInput");

    /* ---------- Utility: Normalize OBD-II Input ---------- */
    function normalizeCodeInput(rawValue) {
      let code = rawValue.trim().toUpperCase();
      if (/^P\d{4}$/.test(code)) return code;
      code = code.replace(/^P/i, "");
      code = code.replace(/\D/g, "");
      code = code.padStart(4, "0").slice(-4);
      return "P" + code;
    }

    function suggestCorrection(inputValue) {
      const padded = normalizeCodeInput(inputValue);
      alert(`Invalid format. Did you mean ${padded}?`);
    }

    /* ---------- Theme Toggle ---------- */
    function toggleTheme() {
      const dark = body.classList.contains("light-mode");
      body.classList.toggle("dark-mode", dark);
      body.classList.toggle("light-mode", !dark);
      toolbarDark.textContent = dark ? "‚òÄÔ∏è Light" : "üåô Dark";
      localStorage.setItem("theme", dark ? "dark" : "light");
    }
    if (localStorage.getItem("theme") === "dark") toggleTheme();
    toolbarDark.addEventListener("click", toggleTheme);

    /* ---------- Format & Display ---------- */
    function formatRecommendations(text) {
      if (!text) return "<p>No recommendation available.</p>";
      const lines = text.split(/\n|‚Ä¢|-|\d\.\s/).map(l => l.trim()).filter(Boolean);
      if (lines.length <= 1) return `<p>${text}</p>`;
      return "<ul>" + lines.map(l => `<li>${l}</li>`).join("") + "</ul>";
    }

    function setupTipsToggle(container, toggleButton) {
      const listItems = container.querySelectorAll("li");
      if (listItems.length > 4) {
        for (let i = 3; i < listItems.length; i++) listItems[i].style.display = "none";
        toggleButton.style.display = "block";
        let expanded = false;
        toggleButton.onclick = () => {
          expanded = !expanded;
          listItems.forEach((li, i) => { if (i >= 3) li.style.display = expanded ? "list-item" : "none"; });
          toggleButton.textContent = expanded ? "Hide Extra Tips ‚ñ≤" : "View More Tips ‚ñº";
        };
      } else toggleButton.style.display = "none";
    }

    function renderForums(code) {
      const forums = document.getElementById("forums");
      const links = [
        { name: "OBD-Codes", url: `https://www.obd-codes.com/${code.toLowerCase()}` },
        { name: "ScannerDanner", url: `https://www.scannerdanner.com/forum` },
        { name: "Reddit Mechanics", url: `https://www.reddit.com/r/MechanicAdvice/search/?q=${code}&restrict_sr=1` },
        { name: "DTC-Search", url: `https://www.dtcsearch.com//${code}` },
      ];
      forums.innerHTML = links.map(l => `<a href="${l.url}" target="_blank">${l.name}</a>`).join(" | ");
    }

    function renderHistory() {
      const history = JSON.parse(localStorage.getItem("lookupHistory") || "[]");
      historyContainer.innerHTML = "";
      if (!history.length) {
        historyContainer.innerHTML = "<p class='text-muted small'>No recent lookups.</p>";
        return;
      }
      const pills = history.map(code => `<div><span class="history-pill">${code}</span></div>`).join("");
      historyContainer.innerHTML = pills;
      document.querySelectorAll(".history-pill").forEach(pill => {
        pill.onclick = () => {
          codeInput.value = pill.textContent;
          performLookup();
        };
      });
    }

    toggleHistory.addEventListener("click", () => {
      const hidden = historyContainer.style.display === "none";
      historyContainer.style.display = hidden ? "flex" : "none";
      toggleHistory.textContent = hidden ? "üïò Recent Lookups ‚ñ≤" : "üïò Recent Lookups ‚ñº";
    });

    /* ---------- Local Cache Functions ---------- */
    function getCache() {
      return JSON.parse(localStorage.getItem("lookupCache") || "{}");
    }

    function setCache(code, data) {
      const cache = getCache();
      cache[code] = { data, timestamp: Date.now() };
      localStorage.setItem("lookupCache", JSON.stringify(cache));
    }

    function getCachedResult(code) {
      const cache = getCache();
      return cache[code] ? cache[code].data : null;
    }

    /* ---------- Main Lookup ---------- */
    async function performLookup() {
      const normalizedCode = normalizeCodeInput(codeInput.value);
      codeInput.value = normalizedCode;

      if (!/^P\d{4}$/.test(normalizedCode)) {
        suggestCorrection(codeInput.value);
        return;
      }

      // ‚ö° Try cache first
      const cached = getCachedResult(normalizedCode);
      if (cached) {
        console.log("Loaded from cache:", normalizedCode);
        renderResult(normalizedCode, cached, true);
        return;
      }

      spinner.style.display = "inline-block";
      document.getElementById("result").style.display = "none";
      toolbarLookup.disabled = true;
      setTimeout(() => toolbarLookup.disabled = false, 800);

      try {
        const res = await fetch("/lookup", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ code: normalizedCode }),
        });
        const data = await res.json();

        renderResult(normalizedCode, data, false);
        setCache(normalizedCode, data); // ‚úÖ cache new result
      } catch (err) {
        alert("Lookup failed. Try again later.");
        console.error(err);
      } finally {
        spinner.style.display = "none";
        codeInput.focus();
      }
    }

    /* ---------- Render Result Helper ---------- */
    function renderResult(code, data, fromCache) {
      document.getElementById("result").style.display = "block";
      document.getElementById("codeTitle").textContent = `Code: ${data.code}`;
      document.getElementById("description").textContent = data.description || "No description.";
      document.getElementById("summary").textContent = data.summary || "No summary.";
      document.getElementById("recommendation").innerHTML = formatRecommendations(data.recommendation);
      setupTipsToggle(document.getElementById("recommendation"), document.getElementById("toggleTips"));
      renderForums(code);

      let history = JSON.parse(localStorage.getItem("lookupHistory") || "[]");
      if (!history.includes(code)) {
        history.unshift(code);
        if (history.length > 10) history = history.slice(0, 10);
        localStorage.setItem("lookupHistory", JSON.stringify(history));
      }
      renderHistory();

      let updated = "Unknown";
      let timestampClass = "timestamp-old";
      if (data.ai_last_updated) {
        const updatedDate = new Date(data.ai_last_updated);
        const now = new Date();
        const diffDays = (now - updatedDate) / (1000 * 60 * 60 * 24);
        updated = updatedDate.toLocaleString();
        timestampClass = diffDays <= 30 ? "timestamp-fresh" : "timestamp-old";
      }

      const cacheInfo = fromCache ? "‚ö° Loaded from Local Cache" : "üåê Fresh from Source";
      document.getElementById("metaInfo").innerHTML =
        `${cacheInfo}<br>Source: ${data.source || "N/A"} | ` +
        `<span class="${timestampClass}">AI Last Updated: ${updated}</span>` +
        `<br><small>Last Checked: ${new Date().toLocaleString()}</small>`;
    }

    toolbarLookup.addEventListener("click", performLookup);
    codeInput.addEventListener("keypress", e => {
      if (e.key === "Enter") performLookup();
    });

    toolbarClear.addEventListener("click", () => {
      localStorage.removeItem("lookupHistory");
      localStorage.removeItem("lookupCache");
      historyContainer.innerHTML = "<p class='text-muted small'>No recent lookups.</p>";
      codeInput.value = "";
      toolbarClear.disabled = true;
      toolbarClear.style.opacity = "0.6";
      setTimeout(() => {
        toolbarClear.disabled = false;
        toolbarClear.style.opacity = "1";
      }, 1000);
    });

    codeInput.addEventListener("focus", e => e.target.select());
    spinner.style.display = "none";
    renderHistory();
  </script>
</body>
</html>
